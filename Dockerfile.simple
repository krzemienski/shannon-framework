# ============================================================================
# Shannon V3 Framework Testing - Simplified Dockerfile
# ============================================================================
# Tests Shannon framework structure, installation, and Python components
# Does NOT require Claude Code CLI - focuses on framework validation
# ============================================================================

FROM ubuntu:22.04

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive \
    TZ=America/New_York \
    PYTHONUNBUFFERED=1 \
    SHANNON_ENV=docker

# Install Python and testing dependencies
RUN apt-get update && apt-get install -y \
    python3=3.10.* \
    python3-pip=22.0.* \
    git=1:2.34.* \
    && rm -rf /var/lib/apt/lists/*

# Install Python testing dependencies
RUN pip3 install --no-cache-dir \
    pytest==7.4.* \
    pyyaml==6.0.* \
    coverage==7.3.*

# Create app directory
WORKDIR /app/shannon

# Copy Shannon framework files
COPY Shannon/ ./Shannon/
COPY setup/ ./setup/
COPY tests/ ./tests/
COPY docs/ ./docs/
COPY scripts/ ./scripts/
COPY CLAUDE.md ./CLAUDE.md
COPY README.md ./README.md
COPY SHANNON_V3_SPECIFICATION.md ./SHANNON_V3_SPECIFICATION.md

# Make scripts executable
RUN chmod +x setup/install.py \
    tests/test_shannon.py \
    tests/test_artifacts.py \
    Shannon/Hooks/precompact.py \
    scripts/verify_shannon.sh

# Create test artifact directories
RUN mkdir -p .shannon/analysis \
    .shannon/checkpoints \
    test-results \
    logs

# Verify Shannon structure
RUN ./scripts/verify_shannon.sh --quick || echo "Some checks failed (expected without full installation)"

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
  CMD python3 -c "from pathlib import Path; assert Path('Shannon/Core').exists()" || exit 1

# Default command: run test suite
CMD ["python3", "-m", "pytest", "tests/", "-v", "--tb=short", "--color=yes"]